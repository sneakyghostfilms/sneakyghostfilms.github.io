---
import Header from './Header.astro';
import Footer from './Footer.astro';
import HeroSlider from './HeroSlider.astro';
import FilmCard from './FilmCard.astro';
import LabsSection from './LabsSection.astro';
import { films } from '../data/films';

interface Props {
  mode: "films" | "labs";
}

const { mode } = Astro.props;
---

<Header isHomePage={true} />

<HeroSlider mode={mode} />

<div class="page-body">
  <!-- Films Content -->
  <div id="films-content" class="content-section films-bokeh-wrap">
    <canvas id="bokeh-canvas"></canvas>
    <!-- Productions Section -->
    <section id="productions">
      <div class="section-inner">
        <div class="wrapper">
          <div class="main-title align-center">
            <h2><strong>Productions</strong></h2>
          </div>
        </div>
        <div class="spacer spacer-medium"></div>
        <div class="portfolio-entries" id="portfolio-grid">
          {films.map((film) => (
            <FilmCard
              title={film.title}
              genre={film.genre}
              slug={film.slug}
              image={film.image}
              categories={film.categories}
            />
          ))}
        </div>
      </div>
    </section>

    <!-- About Section -->
    <section id="about">
      <div class="section-inner">
        <div class="wrapper">
          <div class="main-title align-center">
            <h2><strong>About Scott</strong></h2>
          </div>
        </div>
        <div class="spacer spacer-big"></div>
        <div id="founder-section">
          <div id="founder-window">
            <div class="imgoverlay overlay-dark overlay-transparent" id="founder-img">
              <img src="/files/uploads/scott-danzig.png" alt="Scott Danzig" loading="lazy" />
              <div class="overlaycaption" style="padding-left: 130px; padding-top: 60px">
                <h4 class="overlay-name title-minimal"><strong>Scott Danzig</strong></h4>
                <div class="separator-small"><span></span></div>
                <ul class="socialmedia-widget alttitle">
                  <li class="imdb"><a href="http://www.imdb.com/name/nm4341698/" aria-label="IMDb"></a></li>
                  <li class="quora"><a href="https://www.quora.com/profile/Scott-Danzig" aria-label="Quora"></a></li>
                  <li class="facebook"><a href="https://www.facebook.com/sneakyghost/" aria-label="Facebook"></a></li>
                  <li class="youtube"><a href="https://www.youtube.com/@sneakyghostfilms" aria-label="YouTube"></a></li>
                </ul>
              </div>
            </div>
            <div id="founder-text-container">
              <div id="founder-text">
                <h5 class="title-minimal" style="color: #FFFFFF">Director</h5>
                <div class="spacer spacer-mini"></div>
                <p>Scott Danzig, also a software engineer and photography enthusiast, first embraced his passion for filmmaking in 2010. He has since leveraged his technical savvy to master the craft through self-study and on-set experience, learning both process and theory. Scott continues to produce his own creative works, competing in film festivals, always experimenting and reaching for the next level. He serves as a community leader, engaging local filmmakers, assisting crews how he can, and mentoring. Scott prides himself for his professionalism, striving for quality and delivering on his promises.</p>
              </div>
            </div>
          </div>
        </div>
        <div class="spacer spacer-big"></div>
        <div class="film-media demo-reel-container">
          <div class="film">
            <h4 class="title-minimal">Demo Reel</h4>
            <div class="spacer spacer-small"></div>
            <div class="fitvidsignore">
              <iframe
                width="800"
                height="450"
                src="https://www.youtube.com/embed/Eals4fFpaBU?rel=0"
                title="Sneaky Ghost Films Demo Reel"
                frameborder="0"
                allowfullscreen
                loading="lazy"
              ></iframe>
            </div>
          </div>
        </div>
        <div class="spacer spacer-small"></div>
      </div>
    </section>
  </div>

  <!-- Labs Content -->
  <div id="labs-content" class="content-section">
    <LabsSection />
  </div>

  <!-- Contact Section (shared between modes) -->
  <section id="contact" class="notoppadding">
    <div class="section-inner">
      <div class="split-section clearfix" id="contact-split">
        <div class="split-left split-half">
          <div class="split-wrapped-content">
            <div class="main-title align-center">
              <h3 data-bigletter="C"><strong>Contact</strong></h3>
              <div class="separator"><span></span></div>
              <h6 class="alttitle title-minimal">Get in touch with<br />Sneaky Ghost</h6>
            </div>
            <form
              id="contact-form"
              action="https://formspree.io/f/maylavkd"
              method="POST"
            >
              <fieldset>
                <div class="form-row clearfix">
                  <label for="full-name">Name *</label>
                  <input type="text" id="full-name" name="name" placeholder="Your name" required />
                </div>
                <div class="form-row clearfix">
                  <label for="email-address">Email *</label>
                  <input type="email" id="email-address" name="_replyto" placeholder="Your@email.address" required />
                </div>
                <div class="form-row clearfix textbox">
                  <label for="message">Message *</label>
                  <textarea id="message" name="message" placeholder="What's up?" rows="5" required></textarea>
                </div>
                <div id="form-note" aria-live="polite">
                  <div class="alert alert-error" style="display: none;">
                    <strong>Error</strong>: Please check your entries!
                  </div>
                  <div class="alert alert-success" style="display: none;">
                    <strong>Success</strong>: Message sent!
                  </div>
                </div>
                <input type="text" name="_gotcha" class="is-hidden" aria-hidden="true" tabindex="-1" />
                <input type="hidden" name="_subject" value="Contact Sneaky Ghost" />
              </fieldset>
              <div class="form-row form-submit">
                <button type="submit" class="submit">Send</button>
              </div>
            </form>
          </div>
        </div>
        <div class="split-right split-half">
          <div class="split-bg">
            <div class="map-loader" style="display:flex;align-items:center;justify-content:center;padding:16px;background:#111;">
              <button class="map-load-btn" type="button" style="font-family:inherit;font-size:14px;padding:10px 14px;border:1px solid #fff;background:transparent;color:#fff;cursor:pointer;">
                Load map
              </button>
            </div>
            <div id="map" style="height: 100%; min-height: 300px;"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <Footer />
</div>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    // Contact form handling
    const contactForm = document.getElementById('contact-form');
    if (contactForm) {
      contactForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target as HTMLFormElement;
        const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
        const errorAlert = form.querySelector('.alert-error') as HTMLElement;
        const successAlert = form.querySelector('.alert-success') as HTMLElement;

        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';
        errorAlert.style.display = 'none';
        successAlert.style.display = 'none';

        try {
          const response = await fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: { 'Accept': 'application/json' }
          });

          if (response.ok) {
            successAlert.style.display = 'block';
            form.reset();
          } else {
            throw new Error('Form submission failed');
          }
        } catch (err) {
          errorAlert.style.display = 'block';
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Send';
        }
      });
    }

    // Lazy load map
    const mapLoadBtn = document.querySelector('.map-load-btn');
    const mapContainer = document.getElementById('map');

    function loadMap() {
      const mapLoader = document.querySelector('.map-loader') as HTMLElement;
      if (mapLoader) mapLoader.style.display = 'none';

      // Load Google Maps script dynamically
      const script = document.createElement('script');
      script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyAbx-haDz214H2OeMtvhdLKsT5o8a4sG04&libraries=marker&map_ids=be44c9d1f4868292&loading=async&callback=initMap';
      script.async = true;
      document.head.appendChild(script);
    }

    (window as any).initMap = function() {
      const latlng = { lat: 40.4406, lng: -79.9959 };
      const map = new google.maps.Map(document.getElementById('map')!, {
        zoom: 14,
        center: latlng,
        scrollwheel: false,
        mapId: 'be44c9d1f4868292',
      });

      const markerElement = document.createElement('div');
      markerElement.style.width = '48px';
      markerElement.style.height = '48px';
      markerElement.style.backgroundImage = 'url(/files/uploads/sneakyghost-pin.png)';
      markerElement.style.backgroundSize = 'contain';

      const marker = new google.maps.marker.AdvancedMarkerElement({
        map: map,
        position: latlng,
        content: markerElement,
        title: 'Sneaky Ghost Films HQ'
      });

      const infowindow = new google.maps.InfoWindow({
        content: '<b>Sneaky Ghost Films HQ</b><br>Pittsburgh, PA'
      });

      marker.addListener('click', () => {
        infowindow.open({ anchor: marker, map, shouldFocus: false });
      });
    };

    if (mapLoadBtn) {
      mapLoadBtn.addEventListener('click', loadMap);
    }

    // Auto-load map when it comes into view
    if ('IntersectionObserver' in window && mapContainer) {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            loadMap();
            observer.disconnect();
          }
        });
      });
      observer.observe(mapContainer);
    }
  });

  // Bokeh canvas for Films background
  (function initBokeh() {
    const canvas = document.getElementById('bokeh-canvas') as HTMLCanvasElement;
    if (!canvas) return;
    const ctx = canvas.getContext('2d')!;

    interface Orb {
      x: number; y: number;
      r: number;
      vx: number; vy: number;
      alpha: number;
      color: number[];
      pulseSpeed: number;
      pulseOffset: number;
    }

    const orbs: Orb[] = [];
    const WARM_COLORS = [
      [255, 210, 120],  // warm gold
      [255, 180, 80],   // amber
      [255, 240, 200],  // soft warm white
      [240, 160, 100],  // deep amber
      [255, 220, 160],  // light gold
      [220, 200, 255],  // cool accent (rare lens flare)
    ];

    function resize() {
      const wrap = canvas.parentElement!;
      canvas.width = wrap.offsetWidth;
      canvas.height = wrap.offsetHeight;
    }

    function createOrbs() {
      orbs.length = 0;
      const w = canvas.width;
      const h = canvas.height;
      const count = Math.max(20, Math.floor((w * h) / 40000));

      for (let i = 0; i < count; i++) {
        const colorIdx = i < count * 0.85
          ? Math.floor(Math.random() * 5) // mostly warm
          : 5; // occasional cool accent
        orbs.push({
          x: Math.random() * w,
          y: Math.random() * h,
          r: 15 + Math.random() * 80,
          vx: (Math.random() - 0.5) * 0.25,
          vy: (Math.random() - 0.5) * 0.15 - 0.05, // slight upward drift
          alpha: 0.015 + Math.random() * 0.045,
          color: WARM_COLORS[colorIdx],
          pulseSpeed: 0.0005 + Math.random() * 0.001,
          pulseOffset: Math.random() * Math.PI * 2,
        });
      }
    }

    function draw(time: number) {
      if (!document.body.classList.contains('mode-films')) {
        requestAnimationFrame(draw);
        return;
      }

      const w = canvas.width;
      const h = canvas.height;

      ctx.clearRect(0, 0, w, h);

      orbs.forEach(o => {
        o.x += o.vx;
        o.y += o.vy;

        // Wrap around
        if (o.x < -o.r) o.x = w + o.r;
        if (o.x > w + o.r) o.x = -o.r;
        if (o.y < -o.r) o.y = h + o.r;
        if (o.y > h + o.r) o.y = -o.r;

        // Pulsing alpha
        const pulse = Math.sin(time * o.pulseSpeed + o.pulseOffset) * 0.4 + 0.6;
        const a = o.alpha * pulse;
        const [cr, cg, cb] = o.color;

        const grad = ctx.createRadialGradient(o.x, o.y, 0, o.x, o.y, o.r);
        grad.addColorStop(0, `rgba(${cr}, ${cg}, ${cb}, ${a * 1.8})`);
        grad.addColorStop(0.4, `rgba(${cr}, ${cg}, ${cb}, ${a})`);
        grad.addColorStop(1, 'transparent');

        ctx.beginPath();
        ctx.arc(o.x, o.y, o.r, 0, Math.PI * 2);
        ctx.fillStyle = grad;
        ctx.fill();
      });

      requestAnimationFrame(draw);
    }

    resize();
    createOrbs();
    window.addEventListener('resize', () => { resize(); createOrbs(); });
    requestAnimationFrame(draw);
  })();
</script>

<style is:global>
  /* Custom responsive fixes */
  @media only screen and (max-width: 640px) {
    .fb-like.right-float {
      display: none !important;
    }
    .fitvidsignore iframe {
      max-width: 100% !important;
      height: auto !important;
      min-height: 200px !important;
    }
    /* Founder/About section mobile fixes */
    #founder-section {
      height: auto !important;
    }
    #founder-window {
      min-width: unset !important;
      left: 0 !important;
      display: flex !important;
      flex-direction: column !important;
    }
    #founder-img {
      float: none !important;
      width: 100% !important;
      max-width: 100% !important;
      height: auto !important;
    }
    #founder-img img {
      width: 100% !important;
      height: auto !important;
    }
    #founder-text-container {
      width: 100% !important;
      padding: 30px 20px !important;
      box-sizing: border-box !important;
    }
    #founder-text p {
      margin: 0 !important;
      line-height: 1.6 !important;
    }
    #founder-text {
      max-width: 100% !important;
      padding: 0 !important;
      position: static !important;
      transform: none !important;
      left: auto !important;
      top: auto !important;
    }
    #founder-img .overlaycaption {
      padding: 15px !important;
      text-align: center !important;
    }
    #about .film-media {
      margin-bottom: 60px !important;
    }
    .demo-reel-container {
      padding: 0 15px !important;
    }
    .demo-reel-container h4 {
      text-align: center !important;
    }
    .demo-reel-container .film {
      min-width: unset !important;
      height: auto !important;
      width: 100% !important;
    }
  }

  /* Responsive layout for most screens */
  @media only screen and (max-width: 1200px) {
    #founder-section {
      height: auto !important;
    }
    #founder-window {
      min-width: unset !important;
      left: 0 !important;
      display: flex !important;
      flex-direction: column !important;
    }
    #founder-img {
      float: none !important;
      width: 100% !important;
      height: auto !important;
    }
    #founder-img img {
      width: 100% !important;
      height: auto !important;
    }
    #founder-text-container {
      width: 100% !important;
      padding: 40px 30px !important;
      box-sizing: border-box !important;
    }
    #founder-text {
      max-width: 600px !important;
      margin: 0 auto !important;
      padding: 0 !important;
      position: static !important;
      transform: none !important;
      left: auto !important;
      top: auto !important;
    }
    #founder-img .overlaycaption {
      padding: 20px !important;
      text-align: center !important;
    }
    .demo-reel-container .film {
      min-width: unset !important;
      height: auto !important;
      width: 100% !important;
    }
  }

  /* Demo reel styles - global overrides */
  .demo-reel-container {
    margin-bottom: 20px !important;
    max-width: 800px !important;
    margin-left: auto !important;
    margin-right: auto !important;
    padding: 0 20px !important;
    box-sizing: border-box !important;
  }
  .demo-reel-container .film {
    min-width: unset !important;
    height: auto !important;
    width: 100% !important;
    left: auto !important;
    right: auto !important;
    margin: 0 auto !important;
  }
  .fitvidsignore {
    position: relative !important;
    width: 100% !important;
    max-width: 800px !important;
    margin: 0 auto !important;
    padding-bottom: 56.25% !important; /* 16:9 aspect ratio */
    height: 0 !important;
    overflow: hidden !important;
  }
  .fitvidsignore iframe {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    max-width: none !important;
  }

  /* Unified dark background for all sections */
  .page-body {
    background: #111 !important;
  }

  /* Bokeh canvas for Films background */
  .films-bokeh-wrap {
    position: relative;
    background: #111 !important;
  }

  #bokeh-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
  }

  .films-bokeh-wrap > section,
  .films-bokeh-wrap > .spacer {
    position: relative;
    z-index: 1;
  }

  /* Contact section - dark theme for both modes */
  #contact {
    background: #111 !important;
  }

  #contact .section-inner {
    position: relative;
    z-index: 1;
  }

  #contact .main-title h3,
  #contact .main-title h3 strong {
    color: #fff !important;
  }

  #contact .alttitle {
    color: rgba(255, 255, 255, 0.7) !important;
  }

  #contact .separator span {
    background: rgba(255, 255, 255, 0.2) !important;
  }

  #contact label {
    color: rgba(255, 255, 255, 0.8) !important;
  }

  #contact input[type="text"],
  #contact input[type="email"],
  #contact textarea {
    background: rgba(255, 255, 255, 0.06) !important;
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    color: #fff !important;
  }

  #contact input[type="text"]::placeholder,
  #contact input[type="email"]::placeholder,
  #contact textarea::placeholder {
    color: rgba(255, 255, 255, 0.35) !important;
  }

  #contact input[type="text"]:focus,
  #contact input[type="email"]:focus,
  #contact textarea:focus {
    border-color: rgba(255, 255, 255, 0.35) !important;
    outline: none !important;
  }

  #contact .submit {
    background: transparent !important;
    color: #fff !important;
    border: 1px solid rgba(255, 255, 255, 0.4) !important;
    transition: all 0.2s ease !important;
  }

  #contact .submit:hover {
    background: rgba(255, 255, 255, 0.1) !important;
    border-color: rgba(255, 255, 255, 0.6) !important;
  }

  /* Contact form centering */
  #contact-split .split-left {
    float: none !important;
    margin: 0 auto !important;
  }
  #contact-split .split-wrapped-content {
    float: none !important;
    margin: 0 auto !important;
    max-width: 500px !important;
  }
  #contact-split .split-right {
    display: none;
  }

  /* Light section headers for Films mode */
  #films-content .main-title h2,
  #films-content .main-title h2 strong {
    color: #fff !important;
  }

  /* CSS Grid for portfolio - replaces isotope masonry */
  #portfolio-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 40px;
    padding: 0 40px;
  }

  #portfolio-grid .portfolio-entry {
    width: 100%;
  }

  #portfolio-grid .entry-thumb {
    position: relative;
    overflow: hidden;
  }

  #portfolio-grid .imgoverlay {
    display: block;
    position: relative;
  }

  #portfolio-grid .imgoverlay img {
    width: 100%;
    height: auto;
    display: block;
  }

  @media (max-width: 1024px) {
    #portfolio-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 30px;
      padding: 0 30px;
    }
  }

  @media (max-width: 640px) {
    #portfolio-grid {
      grid-template-columns: 1fr;
      gap: 20px;
      padding: 0 20px;
    }
  }
</style>
